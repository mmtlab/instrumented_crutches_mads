# Instrumented Crutches - Web Interface

FastAPI-based web interface for instrumented crutches data acquisition and visualization system.
Designed for Raspberry Pi Zero 2 W - plain HTTP, no authentication, maximum simplicity.

## Features

- **Recording Control**: Start/stop acquisition with real-time timer
- **Data Visualization**: Interactive charts with Chart.js showing left/right crutch force data
- **Calibration**: Set sensor offset via web interface
- **MADS Integration**: Sends commands via `mads-bridge` to control MADS filter/sink plugins
- **HDF5 Data Storage**: Reads recorded data from HDF5 files with separate timestamps per crutch

## Architecture

The system integrates with MADS (Modular Acquisition and Data System):
- Sends `start`/`stop`/`set_offset` commands via `mads-bridge` to topic `ws_command`
- Reads HDF5 files generated by `hdf5_writer` sink plugin
- Supports independent left/right crutch data with separate timestamps (`ts_left`, `ts_right`)

## Setup

```bash
# Create and activate venv (recommended)
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

**Dependencies:**
- FastAPI + Uvicorn (web server)
- h5py (HDF5 file reading)
- python-dateutil (timestamp parsing)

## Run

```bash
python web_server.py
```

Then open `http://localhost:8000` in your browser.

## Pages

- **`/` (Control)** - Start/stop recordings, set offset, view real-time timer
- **`/static/visualization.html`** - Interactive data visualization with Chart.js

## API Endpoints

### Recording Control
- `POST /start` - Start acquisition (sends `{"command":"start","id":N}` via bridge)
- `POST /stop` - Stop acquisition (sends `{"command":"stop","id":N}` via bridge)
- `POST /set_offset` - Set sensor offset (sends `{"command":"set_offset"}` via bridge)

### Data Access
- `GET /acquisitions` - List all recordings with metadata
- `GET /acquisitions/{id}` - Get data for specific recording (returns left/right force with timestamps)

### Data Format

Acquisition data response:
```json
{
  "acquisition_id": "acq_1",
  "status": "completed",
  "start_time": "2026-01-14T15:30:00",
  "samples": 300,
  "data": {
    "ts_left": [0.0, 0.02, 0.04, ...],
    "left": [45.2, 47.8, 43.1, ...],
    "ts_right": [0.0, 0.02, 0.04, ...],
    "right": [52.1, 50.3, 55.7, ...]
  }
}
```

## Data Storage

- **Acquisitions Index**: `data/index.json` - metadata for all recordings
- **HDF5 Files**: `data/acq_N.h5` - force and timestamp data
  - `/loadcell/left` - left crutch force values
  - `/loadcell/right` - right crutch force values  
  - `/loadcell/ts_left` - left crutch timestamps (ms epoch)
  - `/loadcell/ts_right` - right crutch timestamps (ms epoch)

Timestamps are stored as milliseconds since epoch and converted to relative seconds for visualization.

## Configuration

The system expects:
- `mads-bridge` executable available in PATH
- MADS broker running on `tcp://localhost:9092`
- HDF5 writer sink saving to `data/` directory

## Visualization

The Chart.js visualization:
- **Red line**: Left crutch force
- **Green line**: Right crutch force
- Supports independent timestamps per crutch (scatter plot with connected lines)
- Auto-loads most recent acquisition on page load
- Dropdown to select other recordings

## Notes

- **Plain HTTP only** - no HTTPS, no authentication
- **Local network only** - designed for trusted local environment
- **Acquisition IDs**: Sequential integers (acq_1, acq_2, etc.)
- **No database** - uses JSON index file for simplicity

## Autostart on Raspberry Pi (systemd)

Create `/etc/systemd/system/instrumented-crutches.service`:

```ini
[Unit]
Description=Instrumented Crutches Web Interface
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/instrumented_crutches/web_server
ExecStart=/home/pi/instrumented_crutches/web_server/venv/bin/python web_server.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Then enable and start:

```bash
sudo systemctl enable instrumented-crutches.service
sudo systemctl start instrumented-crutches.service
```
